# üö® CRITICAL: Anchor Version Management

## The Problem

The frontend **MUST** use Anchor 0.29.0 to match the IDLs generated by the Rust programs.

**ERROR SYMPTOM:**
```
TypeError: Cannot read properties of undefined (reading '_bn')
```

This error appears when:
- Anchor 0.30.x SDK tries to parse 0.29.0 IDLs
- npm automatically upgrades `@coral-xyz/anchor` during install

## The Fix

### When You See the `_bn` Error:

```bash
# 1. Remove the wrong version
rm -rf node_modules/@coral-xyz/anchor

# 2. Manually install 0.29.0 from tarball
curl -L https://registry.npmjs.org/@coral-xyz/anchor/-/anchor-0.29.0.tgz | tar -xz -C node_modules/@coral-xyz/
mv node_modules/@coral-xyz/package node_modules/@coral-xyz/anchor

# 3. Verify version
cat node_modules/@coral-xyz/anchor/package.json | grep '"version"'
# Should show: "version": "0.29.0"
```

## Prevention Rules

### ‚ö†Ô∏è NEVER run these commands:
```bash
npm install                    # Will upgrade Anchor
npm install <package>          # Will upgrade Anchor
npm update                     # Will upgrade Anchor
npm install --force            # Will upgrade Anchor
```

### ‚úÖ ALWAYS use `--no-save` flag:
```bash
npm install --no-save <package>   # Safe
npm install -D --no-save <package>  # Safe for dev dependencies
```

## Why This Happens

1. `package.json` has:
   ```json
   "@coral-xyz/anchor": "https://registry.npmjs.org/@coral-xyz/anchor/-/anchor-0.29.0.tgz"
   ```

2. But npm's dependency resolver sometimes ignores tarball URLs and installs the latest version (0.30.1)

3. The `overrides` and `resolutions` fields don't always work with tarball URLs

## Permanent Solution (When You Have Time)

1. **Option A**: Update all IDLs to Anchor 0.30.x
   ```bash
   cd programs/fate-protocol
   # Update Anchor CLI to 0.30.x
   anchor build
   # Copy new IDLs to app/lib/idl/
   ```

2. **Option B**: Use npm/yarn workspaces with strict version locking

3. **Option C**: Use pnpm which respects version locks better

## Quick Check Command

```bash
# Run this anytime you suspect the version changed:
cat node_modules/@coral-xyz/anchor/package.json | grep version
```

Expected output: `"version": "0.29.0"`

If you see `0.30.1` or anything else, run the fix above.

---

**Last Updated:** December 12, 2025
**Status:** Anchor 0.29.0 is currently installed and working
